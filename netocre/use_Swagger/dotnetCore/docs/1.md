ä½ è¿™ä¸ªå®¹å™¨é‡Œåªæœ‰ 4 ä¸ªè¯ä¹¦ï¼Œè€Œä¸” /etc/pki/ca-trust/source/anchors æ”¾äº†ä¸¤å¼ â€œäºŒå±‚ï¼ˆä¸­é—´ï¼‰è¯ä¹¦â€ã€‚è¿™ä¼šå¯¼è‡´ .NET æ ¡éªŒå¤±è´¥ï¼šç³»ç»Ÿæ—¢æ²¡æœ‰å…¬å…±æ ¹ CA é›†åˆï¼Œä¹Ÿæ²¡æœ‰ä½ ä»¬å…¬å¸çš„æ ¹ CAï¼ˆä¸€çº§ï¼‰ã€‚ä»…æœ‰ä¸­é—´è¯ä¹¦é€šå¸¸ä¸å¤Ÿã€‚

ä¸‹é¢æŒ‰ CentOS/RHEL/UBI ç³»ç»Ÿç»™å‡ºæœ€å°å¯æ‰§è¡Œæ–¹æ¡ˆï¼ˆå…ˆå…¬å…±æ ¹ï¼Œå†å…¬å¸æ ¹ï¼‰ï¼š

â¸»

A. å…ˆæŠŠå…¬å…±æ ¹è¯ä¹¦è£…å…¨ï¼ˆå¿…åšï¼‰

è¿›å…¥å®¹å™¨ï¼ˆæœ‰ rootï¼‰æ‰§è¡Œï¼š
```
( command -v dnf >/dev/null && dnf install -y ca-certificates ) \
 || ( command -v yum >/devnull && yum install -y ca-certificates ) \
 || ( command -v microdnf >/dev/null && microdnf install -y ca-certificates )

update-ca-trust force-enable
update-ca-trust extract

# è‡ªæ£€ï¼šåº”ä» 4 å¼  => æ•°ç™¾å¼ 
ls -1 /etc/ssl/certs | wc -l
```
è£…å®Œè¿™ä¸€æ­¥ï¼Œè®¿é—®å…¬ç½‘æ­£è§„è¯ä¹¦çš„ç½‘ç«™ï¼ˆDigiCert/GlobalSign ç­‰ï¼‰é€šå¸¸å°±èƒ½é€šè¿‡ã€‚

â¸»

B. å†å¯¼å…¥å…¬å¸/è‡ªç­¾æ ¹ CAï¼ˆå¦‚ä½ ä»¬æœ‰ HTTPS å®¡è®¡/ä»£ç†ï¼‰

é‡ç‚¹ï¼šè¦å¯¼å…¥â€œæ ¹ CAï¼ˆä¸€çº§ï¼‰â€ï¼Œä¸æ˜¯ä»…å¯¼å…¥ä¸­é—´ï¼ˆäºŒå±‚ï¼‰è¯ä¹¦ã€‚
å¦‚æœä½ æ‰‹ä¸Šåªæœ‰â€œäºŒå±‚è¯ä¹¦.crtâ€ï¼Œè¯·å‘å®‰å…¨/ç½‘ç»œåŒäº‹ç´¢å–æ ¹ CAã€‚æ‹¿åˆ°æ ¹ CAï¼ˆPEM æ–‡æœ¬ï¼‰åï¼š
```
# å‡è®¾æ–‡ä»¶å corp-root.pemï¼ˆPEM æ–‡æœ¬ï¼‰
cp /path/corp-root.pem /etc/pki/ca-trust/source/anchors/corp-root.crt
# å¦‚éœ€ä¹Ÿä¿ç•™ç°æœ‰äºŒå±‚è¯ä¹¦ï¼Œå¯ä¸€å¹¶æ”¾å…¥ anchors
# cp /path/intermediate.pem /etc/pki/ca-trust/source/anchors/intermediate.crt

update-ca-trust extract
```
æ–‡ä»¶è¦æ±‚ï¼šPEM æ–‡æœ¬ï¼ˆä»¥ -----BEGIN CERTIFICATE----- å¼€å¤´ï¼‰ï¼Œåç¼€å»ºè®® .crtã€‚DER/cer éœ€å…ˆè½¬ï¼š
openssl x509 -inform der -in in.cer -out out.crt

â¸»

C. å¿«é€ŸéªŒè¯

åŒä¸€å®¹å™¨é‡ŒéªŒè¯ä¿¡ä»»é“¾æ˜¯å¦ OKï¼š
```
# 1) æŸ¥çœ‹æ•°é‡
ls -1 /etc/ssl/certs | wc -l

# 2) curl ç›®æ ‡åŸŸåï¼ˆæˆåŠŸåˆ™å¤§æ¦‚ç‡ .NET ä¹Ÿé€šè¿‡ï¼‰
curl -v https://ä½ çš„åŸŸå/ -o /dev/null

# 3) çœ‹é“¾æ˜¯å¦å®Œæ•´/æ˜¯å¦æœ‰ NameMismatch
openssl s_client -connect ä½ çš„åŸŸå:443 -servername ä½ çš„åŸŸå -showcerts </dev/null | sed -n '1,200p'

	â€¢	è‹¥ curl ä» certificate verify failedï¼šè¦ä¹ˆæ ¹ CA è¿˜æ˜¯æ²¡å¯¼å…¥ï¼Œè¦ä¹ˆå¯¹æ–¹æœåŠ¡å™¨æ²¡å¸¦é½ä¸­é—´è¯ä¹¦ï¼ˆè®©å¯¹æ–¹è¡¥å…¨é“¾ï¼‰ã€‚
	â€¢	è‹¥æç¤º hostname mismatchï¼šä½ æ˜¯åœ¨ç”¨ IP æˆ– Host ä¸åŒ¹é…è¯ä¹¦çš„åŸŸåï¼›å¿…é¡»ç”¨è¯ä¹¦ CN/SAN ä¸­çš„åŸŸåè®¿é—®ã€‚
```
â¸»

D. åº”ç”¨ä¾§å¯é€‰â€œä¿é™©ä¸â€ï¼ˆä¸æ›¿ä»£ä¿¡ä»»åº“ï¼‰
```
// å¼ºåˆ¶ TLS1.2ï¼ˆéƒ¨åˆ†æ—§æœåŠ¡éœ€è¦ï¼‰
var handler = new HttpClientHandler { SslProtocols = System.Security.Authentication.SslProtocols.Tls12 };

// å¯¹ä¸ªåˆ« H2 å…¼å®¹å·®çš„æœåŠ¡ï¼Œå¼ºåˆ¶ HTTP/1.1
var req = new HttpRequestMessage(HttpMethod.Get, url) { Version = System.Net.HttpVersion.Version11 };
```
ä»…æ’æŸ¥æ—¶å¯ä»¥ä¸´æ—¶å¿½ç•¥æ ¡éªŒï¼Œä½†ç”Ÿäº§ç¯å¢ƒä¸è¦ï¼š
handler.ServerCertificateCustomValidationCallback = HttpClientHandler.DangerousAcceptAnyServerCertificateValidator;

â¸»

E. å›ºåŒ–åˆ°é•œåƒï¼ˆæ¨èï¼‰
```
FROM registry.access.redhat.com/ubi8/ubi-minimal

RUN microdnf install -y ca-certificates && microdnf clean all \
 && update-ca-trust force-enable && update-ca-trust extract

# å¦‚éœ€å…¬å¸æ ¹ CAï¼ˆæŠŠ corp-root.pem æ”¾åˆ°æ„å»ºä¸Šä¸‹æ–‡ï¼‰
# COPY corp-root.pem /etc/pki/ca-trust/source/anchors/corp-root.crt
# RUN update-ca-trust extract

# ... COPY ä½ çš„åº”ç”¨å¹¶è¿è¡Œ
```

â¸»

ä½ ç°åœ¨çš„çŠ¶æ€æ€ä¹ˆå¤„ç†ï¼Ÿ
	â€¢	ä½ åªæœ‰ä¸¤å¼ â€œäºŒå±‚è¯ä¹¦â€ï¼Œè¯·è¡¥é½â€œå…¬å¸æ ¹ CAï¼ˆä¸€çº§ï¼‰â€ æ”¾åˆ° /etc/pki/ca-trust/source/anchors/xxx.crtï¼Œç„¶å update-ca-trust extractã€‚
	â€¢	åŒæ—¶å®‰è£… ca-certificatesï¼Œç¡®ä¿å…¬å…±ç«™ç‚¹ä¹Ÿèƒ½æ­£å¸¸è®¿é—®ã€‚
	â€¢	å†è·‘ä½ ä¹‹å‰çš„ /_sslcheckï¼ŒTotalFiles åº”è¯¥æ˜æ˜¾ä¸Šå‡ï¼ŒSteps.default å¾ˆå¯èƒ½å˜ä¸ºæˆåŠŸï¼›è‹¥ä»å¤±è´¥ï¼Œè´´ä¸€ä¸‹ curl -v çš„å…³é”®ä¿¡æ¯ï¼ˆæˆ– openssl s_client å‰å‡ æ®µï¼‰ï¼Œæˆ‘å¸®ä½ åˆ¤å®šæ˜¯â€œé“¾ä¸å®Œæ•´â€è¿˜æ˜¯â€œåŸŸåä¸åŒ¹é…â€ã€‚

â¸»------â¸»------â¸»------â¸»------â¸»------â¸»------


ä½ æ‹¿åˆ°çš„ .crt + ç§é’¥ï¼Œå¸¸è§æœ‰ä¸¤ç§ç”¨é€”ï¼Œè¦åˆ†æ¸…æ¥šï¼š

â¸»

ğŸ“Œ åœºæ™¯ 1ï¼šè¿™æ˜¯æœåŠ¡å™¨è¯ä¹¦ï¼ˆç«™ç‚¹è¯ä¹¦ + ç§é’¥ï¼‰

ğŸ‘‰ ç”¨æ¥åœ¨ ä½ çš„æœåŠ¡ç«¯ é…ç½® HTTPSï¼ˆKestrelã€Nginxã€Apacheï¼‰ã€‚
.NET Core 3.0 è‡ªå¸¦çš„ Kestrel å°±èƒ½ç›´æ¥åŠ è½½ï¼š
```
// Program.cs / CreateHostBuilder
public static IHostBuilder CreateHostBuilder(string[] args) =>
    Host.CreateDefaultBuilder(args)
        .ConfigureWebHostDefaults(webBuilder =>
        {
            webBuilder.ConfigureKestrel(serverOptions =>
            {
                serverOptions.ListenAnyIP(5001, listenOptions =>
                {
                    listenOptions.UseHttps("server.crt", "server.key");
                });
            });
            webBuilder.UseStartup<Startup>();
        });
```

âš ï¸ .crt å’Œ .key å¿…é¡»æ˜¯ PEM æ–‡æœ¬æ ¼å¼ã€‚å¦‚æœæ˜¯åˆ«çš„æ ¼å¼ï¼Œå¯ä»¥ç”¨ openssl è½¬æ¢ã€‚


ğŸ“Œ åœºæ™¯ 2ï¼šè¿™æ˜¯å®¢æˆ·ç«¯è¯ä¹¦ï¼ˆmTLS åŒå‘è®¤è¯ç”¨ï¼‰

ğŸ‘‰ ç”¨æ¥åœ¨ è°ƒç”¨ç¬¬ä¸‰æ–¹ HTTPS æ¥å£ æ—¶åšå®¢æˆ·ç«¯è®¤è¯ã€‚
è¿™ç§æƒ…å†µä¸‹ï¼Œä½ éœ€è¦æŠŠ .crt å’Œ .key åˆå¹¶æˆä¸€ä¸ª .pfxï¼ˆPKCS#12 æ ¼å¼ï¼‰ï¼Œç„¶ååœ¨ HttpClient åŠ è½½ï¼š

1. ç”¨ openssl åˆå¹¶
```
# crt + key åˆå¹¶æˆä¸€ä¸ª PFXï¼Œå¯¼å‡ºæ—¶ä¼šè®©ä½ è®¾ç½®å¯†ç 
openssl pkcs12 -export -out client.pfx -inkey client.key -in client.crt
```
2. .NET Core åŠ è½½å®¢æˆ·ç«¯è¯ä¹¦
```
using System.Net.Http;
using System.Security.Cryptography.X509Certificates;

var handler = new HttpClientHandler();

// åŠ è½½ PFX æ–‡ä»¶
var cert = new X509Certificate2("client.pfx", "pfxå¯†ç ", X509KeyStorageFlags.MachineKeySet);
handler.ClientCertificates.Add(cert);

var client = new HttpClient(handler);
var res = await client.GetAsync("https://thirdparty.example.com/api");
Console.WriteLine(await res.Content.ReadAsStringAsync());
```

â¸»

ğŸ“Œ åœºæ™¯ 3ï¼šè¿™æ˜¯ CA è¯ä¹¦ï¼ˆæ ¹/ä¸­é—´è¯ä¹¦ï¼‰

ğŸ‘‰ ç”¨æ¥è®©å®¹å™¨ä¿¡ä»»å¯¹æ–¹çš„ç«™ç‚¹è¯ä¹¦ã€‚
è¿™ç§æƒ…å†µ ä¸éœ€è¦ç§é’¥ï¼Œåªéœ€è¦æŠŠ .crt æ”¾åˆ°å®¹å™¨çš„ä¿¡ä»»åº“ï¼š
```
cp myca.crt /etc/pki/ca-trust/source/anchors/
update-ca-trust extract
```

â¸»

ğŸ” å¦‚ä½•åˆ¤æ–­æ˜¯å“ªç§ï¼Ÿ
	â€¢	å¦‚æœè¯ä¹¦ä¸Š Subject/CN æ˜¯ä½ è‡ªå·±æœåŠ¡çš„åŸŸå â†’ åœºæ™¯ 1ï¼ˆæœåŠ¡å™¨ç«¯è¯ä¹¦ï¼‰ã€‚
	â€¢	å¦‚æœå¯¹æ–¹æ˜ç¡®è¯´â€œè°ƒç”¨æ¥å£éœ€è¦å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯â€ â†’ åœºæ™¯ 2ï¼ˆå®¢æˆ·ç«¯è¯ä¹¦ï¼‰ã€‚
	â€¢	å¦‚æœè¯ä¹¦æ–‡ä»¶åªæœ‰å…¬é’¥ï¼Œæ²¡æœ‰é…å¥—ç§é’¥ï¼Œè€Œä¸”åç§°ç±»ä¼¼ rootCA.crtã€intermediate.crt â†’ åœºæ™¯ 3ï¼ˆCA è¯ä¹¦ï¼‰ã€‚

â¸»



```
( command -v dnf >/dev/null && dnf install -y ca-certificates ) \
 || ( command -v yum >/devnull && yum install -y ca-certificates ) \
 || ( command -v microdnf >/dev/null && microdnf install -y ca-certificates )
```
æœ¬è´¨ä¸Šæ˜¯é€šè¿‡ åŒ…ç®¡ç†å™¨ï¼ˆdnf / yum / microdnfï¼‰ å»ä¸‹è½½å¹¶å®‰è£… ca-certificates åŒ…ã€‚

ğŸ‘‰ è¿™ä¸€æ­¥éœ€è¦å®¹å™¨èƒ½è®¿é—®å¤–éƒ¨è½¯ä»¶æºï¼ˆä¸€èˆ¬æ˜¯å…¬ç½‘çš„ yum repoï¼‰ï¼Œæ‰èƒ½æ‹‰å– rpm åŒ…ã€‚

â¸»

å¦‚æœå®¹å™¨æ²¡æ³•è¿å…¬ç½‘æ€ä¹ˆåŠï¼Ÿ

ä½ æœ‰å‡ ä¸ªé€‰æ‹©ï¼š
	1.	ç”¨å…¬å¸å†…éƒ¨ yum ä»“åº“
	â€¢	å¾ˆå¤šä¼ä¸šå†…ç½‘éƒ½æœ‰é•œåƒä»“åº“ï¼Œä½ æŠŠå®¹å™¨é…ç½®æˆæŒ‡å‘å†…ç½‘ yum repoï¼Œå°±èƒ½è£… ca-certificates åŒ…ã€‚
	2.	åœ¨ Docker é•œåƒæ„å»ºé˜¶æ®µå°±è£…å¥½
	â€¢	åœ¨æ„å»ºç¯å¢ƒèƒ½è®¿é—®å¤–ç½‘æ—¶ RUN yum install -y ca-certificates && update-ca-trust extractï¼Œè¿™æ ·ç”Ÿæˆçš„é•œåƒå¸¦ç€è¯ä¹¦åº“ï¼Œè¿è¡Œæ—¶å³ä½¿ä¸èƒ½è”ç½‘ä¹Ÿèƒ½ç”¨ã€‚
	3.	æ‰‹åŠ¨æ‹·è´ CA åŒ…æ–‡ä»¶
	â€¢	åœ¨ä¸€å°èƒ½è”ç½‘çš„æœºå™¨ä¸Šä¸‹è½½å¯¹åº” rpmï¼Œä¾‹å¦‚ï¼š
```
yum install --downloadonly --downloaddir=/tmp ca-certificates
```

	â€¢	ç„¶åæŠŠ rpm æ‹·è´è¿›å®¹å™¨ï¼Œæ‰‹å·¥ rpm -ivh ca-certificates-xxx.rpm å®‰è£…ã€‚

	4.	ç›´æ¥æ‹·è´è¯ä¹¦æ–‡ä»¶
	â€¢	å¦‚æœç›®æ ‡æ¥å£åªéœ€è¦ç‰¹å®š CA ä¿¡ä»»ï¼ˆæ¯”å¦‚ä½ æ‰‹é‡Œæœ‰ .crt æ–‡ä»¶ï¼‰ï¼Œä½ å¯ä»¥ä¸ç”¨è£…æ•´ä¸ªåŒ…ï¼Œåªéœ€è¦ï¼š
```
cp myca.crt /etc/pki/ca-trust/source/anchors/
update-ca-trust extract
```

	â€¢	è¿™æ ·å®¹å™¨å°±èƒ½ä¿¡ä»»è¯¥è¯ä¹¦é“¾äº†ã€‚

â¸»

ğŸ”‘ æ€»ç»“ï¼š
	â€¢	å¦‚æœä½ èƒ½è®¿é—®å¤–éƒ¨ yum æº â†’ ç›´æ¥è¿è¡Œé‚£æ¡å‘½ä»¤å³å¯ã€‚
	â€¢	å¦‚æœä¸èƒ½è”ç½‘ â†’ è¦ä¹ˆç”¨ å†…ç½‘ yum æºï¼Œè¦ä¹ˆåœ¨ é•œåƒæ„å»ºæ—¶å°±è£…å¥½ï¼Œè¦ä¹ˆ æ‰‹åŠ¨æ‹·è´ rpm æˆ– CA è¯ä¹¦ã€‚

è¦ä¸è¦æˆ‘å¸®ä½ å†™ä¸€ä¸ª Dockerfile ç¤ºä¾‹ï¼ŒåŒºåˆ†â€œèƒ½è”ç½‘â€å’Œâ€œç¦»çº¿ rpm å®‰è£…/æ‹·è´è¯ä¹¦â€çš„ä¸¤ç§æƒ…å†µï¼Ÿ



æ˜ç™½ âœ…ã€‚åœ¨ ç¦»çº¿ç¯å¢ƒé‡Œï¼Œä½ ä¸èƒ½ç›´æ¥ yum install ca-certificatesï¼Œéœ€è¦å…ˆæŠŠ rpm åŒ…å‡†å¤‡å¥½ï¼Œå†æ”¾è¿›å®¹å™¨å®‰è£…ã€‚ä¸‹é¢ç»™ä½ ä¸€ä¸ªå®Œæ•´æµç¨‹ï¼š

â¸»

1. åœ¨ä¸€å°èƒ½è”ç½‘çš„ CentOS/RHEL æœºå™¨ä¸Šä¸‹è½½ rpm

ä»¥ CentOS 8 ä¸ºä¾‹ï¼š
```
# åˆ›å»ºç¦»çº¿åŒ…ç›®å½•
mkdir -p /tmp/rpms

# ä¸‹è½½ ca-certificates åŒ…ï¼ˆä»…ä¸‹è½½ï¼Œä¸å®‰è£…ï¼‰
yum install --downloadonly --downloaddir=/tmp/rpms ca-certificates

# ä¹Ÿå¯ä»¥æŠŠä¾èµ–ä¸€å¹¶æ‹‰ä¸‹æ¥ï¼ˆä¿é™©ï¼‰
yum install --downloadonly --downloaddir=/tmp/rpms --resolve ca-certificates
```
ä¼šåœ¨ /tmp/rpms ç›®å½•ä¸‹å¾—åˆ° ca-certificates-*.rpm ä»¥åŠç›¸å…³ä¾èµ– rpmã€‚

â¸»

2. æŠŠ rpm æ–‡ä»¶æ‹·è´åˆ°ç¦»çº¿å®¹å™¨é‡Œ

æœ‰ä¸¤ç§æ–¹å¼ï¼š
	â€¢	æ„å»ºé•œåƒæ—¶ COPYï¼š
```
FROM centos:8
COPY rpms /tmp/rpms
RUN rpm -ivh /tmp/rpms/*.rpm --nodeps --force \
 && update-ca-trust force-enable \
 && update-ca-trust extract
```

	â€¢	å·²è¿è¡Œå®¹å™¨ç”¨ docker cp æ‹·è¿›å»ï¼š
```
docker cp /tmp/rpms <å®¹å™¨id>:/tmp/rpms
docker exec -it <å®¹å™¨id> rpm -ivh /tmp/rpms/*.rpm --nodeps --force
docker exec -it <å®¹å™¨id> update-ca-trust force-enable
docker exec -it <å®¹å™¨id> update-ca-trust extract
```


â¸»

3. éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸ

å®¹å™¨é‡Œæ‰§è¡Œï¼š
```
ls -1 /etc/ssl/certs | wc -l
```
	â€¢	å¦‚æœç»“æœæ˜¯ å‡ ç™¾æ¡ï¼ˆæ­£å¸¸ç³»ç»Ÿæ ¹è¯ä¹¦æ•°é‡ï¼‰ï¼Œè¯´æ˜æˆåŠŸã€‚
	â€¢	å†æµ‹ï¼š
```
curl -v https://www.google.com -o /dev/null
```
å¦‚æœèƒ½è¿ä¸Šï¼Œè¯´æ˜ .NET Core é‡Œçš„ HttpClient ä¹Ÿèƒ½æ­£å¸¸ç”¨äº†ã€‚

â¸»

4. å¦‚æœä½ åªæœ‰å…¬å¸å†…éƒ¨çš„æ ¹è¯ä¹¦ï¼ˆæ²¡æœ‰ rpm åŒ…ï¼‰

ä½ ä¹Ÿå¯ä»¥ç›´æ¥æŠŠ .crt æ”¾åˆ°ç³»ç»Ÿä¿¡ä»»åº“ï¼š
```
# å‡è®¾æ–‡ä»¶å« corp-root.crt
cp corp-root.crt /etc/pki/ca-trust/source/anchors/
update-ca-trust extract
```
è¿™æ¯”å®Œæ•´å®‰è£… ca-certificates åŒ…æ›´è½»é‡ï¼Œä½†åªèƒ½ä¿¡ä»»ä½ å¯¼å…¥çš„è¯ä¹¦é“¾ã€‚

â¸»

âš ï¸ æ€»ç»“ï¼š
	â€¢	æ¨èï¼šå‡†å¤‡å¥½ ca-certificates çš„ rpm åŒ…ï¼Œç¦»çº¿å®‰è£…åˆ°å®¹å™¨ã€‚
	â€¢	åªè®¿é—®ç‰¹å®šæ¥å£ï¼šç›´æ¥æ‹·è´å¯¹åº”çš„æ ¹ CA crt æ–‡ä»¶åˆ° /etc/pki/ca-trust/source/anchors/ å† update-ca-trust extract å°±å¯ä»¥ã€‚

â¸»

è¦ä¸è¦æˆ‘å¸®ä½ å†™ä¸€ä¸ª é€šç”¨çš„ Dockerfileï¼ˆç¦»çº¿ç‰ˆï¼‰ï¼Œé‡Œé¢æ”¯æŒä¸¤ç§æ¨¡å¼ï¼š
	1.	å¤åˆ¶ rpm åŒ…å¹¶å®‰è£…ï¼›
	2.	å¤åˆ¶è‡ªå®šä¹‰æ ¹è¯ä¹¦å¹¶å¯¼å…¥ï¼Ÿ



//////////

å¥½çš„ ğŸ‘ æˆ‘ç»™ä½ ä¸€ä¸ªçœŸå®çš„ curl -v https://www.google.com -o /dev/null çš„ç¤ºä¾‹è¾“å‡ºï¼Œå¹¶é€æ®µè§£é‡Šã€‚

â¸»

ç¤ºä¾‹è¾“å‡º

*   Trying 142.250.217.36:443...
* Connected to www.google.com (142.250.217.36) port 443 (#0)
* ALPN, offering h2
* ALPN, offering http/1.1
* successfully set certificate verify locations:
*   CAfile: /etc/ssl/certs/ca-certificates.crt
*   CApath: /etc/ssl/certs
* TLSv1.3 (OUT), TLS handshake, Client hello (1):
* TLSv1.3 (IN), TLS handshake, Server hello (2):
* TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):
* TLSv1.3 (IN), TLS handshake, Certificate (11):
* TLSv1.3 (IN), TLS handshake, CERT verify (15):
* TLSv1.3 (IN), TLS handshake, Finished (20):
* TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):
* TLSv1.3 (OUT), TLS handshake, Finished (20):
* SSL connection using TLSv1.3 / AES256-GCM-SHA384
* ALPN, server accepted to use h2
* Server certificate:
*  subject: CN=www.google.com
*  start date: Sep  5 07:00:00 2024 GMT
*  expire date: Nov 28 07:00:00 2024 GMT
*  subjectAltName: host "www.google.com" matched cert's "www.google.com"
*  issuer: C=US; O=Google Trust Services; CN=GTS CA 1C3
*  SSL certificate verify ok.
> GET / HTTP/2
> Host: www.google.com
> user-agent: curl/7.81.0
> accept: */*
>
< HTTP/2 200
< content-type: text/html; charset=ISO-8859-1
< date: Fri, 13 Sep 2024 01:20:33 GMT
< expires: -1
< cache-control: private, max-age=0
< content-length: 219
< server: gws
< x-frame-options: SAMEORIGIN
<
{ [219 bytes data]
* Connection #0 to host www.google.com left intact


â¸»

é€æ®µè§£é‡Š
	1.	DNS & è¿æ¥
```
*   Trying 142.250.217.36:443...
* Connected to www.google.com (142.250.217.36) port 443 (#0)
```
	â€¢	curl è§£æ www.google.com å¾—åˆ° IP 142.250.217.36ï¼Œå¹¶æˆåŠŸå»ºç«‹ TCP è¿æ¥ï¼ˆ443 ç«¯å£ï¼‰ã€‚

	2.	ALPN åå•†ï¼ˆApplication Layer Protocol Negotiationï¼‰
``
* ALPN, offering h2
* ALPN, offering http/1.1
```
	â€¢	å®¢æˆ·ç«¯å‘Šè¯‰æœåŠ¡ç«¯ï¼Œå®ƒæ”¯æŒ HTTP/2ï¼ˆh2ï¼‰å’Œ HTTP/1.1ã€‚

	3.	è¯ä¹¦éªŒè¯é…ç½®
```
* successfully set certificate verify locations:
*   CAfile: /etc/ssl/certs/ca-certificates.crt
*   CApath: /etc/ssl/certs
```
	â€¢	curl ç”¨ç³»ç»Ÿ CA æ ¹è¯ä¹¦æ–‡ä»¶/ç›®å½•åšæ ¡éªŒã€‚
	â€¢	å¦‚æœä½ çš„å®¹å™¨é‡Œè¿™ä¸ªæ–‡ä»¶æ•°é‡å¾ˆå°‘ï¼ˆå°±åƒä½ ä¹‹å‰é‚£æ ·ï¼‰ï¼Œä¼šå¯¼è‡´â€œcertificate verify failedâ€ã€‚

	4.	TLS æ¡æ‰‹
```
* TLSv1.3 (OUT), TLS handshake, Client hello (1):
* TLSv1.3 (IN), TLS handshake, Server hello (2):
...
* SSL connection using TLSv1.3 / AES256-GCM-SHA384

	â€¢	åŒæ–¹åå•†ä½¿ç”¨ TLS 1.3ï¼Œå¯†ç å¥—ä»¶ AES256-GCM-SHA384ã€‚

	5.	æœåŠ¡ç«¯è¯ä¹¦

* Server certificate:
*  subject: CN=www.google.com
*  start date: Sep  5 07:00:00 2024 GMT
*  expire date: Nov 28 07:00:00 2024 GMT
*  subjectAltName: host "www.google.com" matched cert's "www.google.com"
*  issuer: C=US; O=Google Trust Services; CN=GTS CA 1C3
*  SSL certificate verify ok.

	â€¢	è¯ä¹¦ä¸»é¢˜ CN=www.google.comï¼›
	â€¢	SAN æ‰©å±•åŒ…å« www.google.comï¼›
	â€¢	é¢å‘è€…æ˜¯ Google Trust Servicesï¼›
	â€¢	ç³»ç»ŸæˆåŠŸéªŒè¯äº†è¯ä¹¦é“¾ â†’ SSL certificate verify ok. âœ…ã€‚

	6.	HTTP è¯·æ±‚ & å“åº”

> GET / HTTP/2
> Host: www.google.com
> user-agent: curl/7.81.0
> accept: */*
...
< HTTP/2 200
< content-type: text/html; charset=ISO-8859-1
< date: Fri, 13 Sep 2024 01:20:33 GMT
< content-length: 219
< server: gws
```
	â€¢	curl å‘èµ·äº†ä¸€ä¸ª GET è¯·æ±‚ï¼›
	â€¢	æœåŠ¡ç«¯è¿”å› 200 OKï¼Œå“åº”å¤´å±•ç¤ºäº†ç±»å‹ã€é•¿åº¦ç­‰ä¿¡æ¯ã€‚

â¸»

ğŸ” å¦‚æœè¯ä¹¦ä¸ä¿¡ä»»æ—¶ä¼šæ€æ ·ï¼Ÿ

æ¯”å¦‚å®¹å™¨æ²¡è£… ca-certificatesï¼Œä¼šçœ‹åˆ°ï¼š

* SSL certificate problem: unable to get local issuer certificate
* Closing connection 0
curl: (60) SSL certificate problem: unable to get local issuer certificate

è¿™æ­£æ˜¯ä½ ä¹‹å‰åœ¨ .NET é‡ŒæŠ¥çš„ "The remote certificate is invalid according to the validation procedure."

â¸»
å¥½çš„ ğŸ‘ æˆ‘æ¥è¡¥ä¸€ä¸ª æˆåŠŸ vs å¤±è´¥çš„ curl -v å¯¹æ¯”è¡¨ï¼Œè¿™æ ·ä½ åœ¨å®¹å™¨é‡Œä¸€è·‘ï¼Œå°±èƒ½ç›´è§‚åˆ¤æ–­æ˜¯å“ªç±»é—®é¢˜ã€‚

â¸»

âœ… æˆåŠŸçš„æƒ…å†µ
```
$ curl -v https://www.google.com -o /dev/null
*   Trying 142.250.217.36:443...
* Connected to www.google.com (142.250.217.36) port 443 (#0)
* ALPN, offering h2
* ALPN, offering http/1.1
* successfully set certificate verify locations:
*   CAfile: /etc/ssl/certs/ca-certificates.crt
*   CApath: /etc/ssl/certs
* TLSv1.3 (OUT), TLS handshake, Client hello (1):
* TLSv1.3 (IN), TLS handshake, Server hello (2):
* SSL connection using TLSv1.3 / AES256-GCM-SHA384
* Server certificate:
*  subject: CN=www.google.com
*  start date: Sep  5 07:00:00 2024 GMT
*  expire date: Nov 28 07:00:00 2024 GMT
*  subjectAltName: host "www.google.com" matched cert's "www.google.com"
*  issuer: C=US; O=Google Trust Services; CN=GTS CA 1C3
*  SSL certificate verify ok.
> GET / HTTP/2
> Host: www.google.com
< HTTP/2 200
< content-type: text/html; charset=ISO-8859-1
< server: gws
* Connection #0 to host www.google.com left intact
```
ğŸ‘‰ å…³é”®ç‚¹ï¼š
	â€¢	SSL certificate verify ok. âœ…
	â€¢	è¿”å›äº† HTTP/2 200ï¼Œè¯´æ˜ TLS + HTTP éƒ½å®Œå…¨æˆåŠŸã€‚

â¸»

âŒ å¸¸è§å¤±è´¥ 1ï¼šæ ¹è¯ä¹¦ç¼ºå¤±
```
$ curl -v https://www.google.com -o /dev/null
*   Trying 142.250.217.36:443...
* Connected to www.google.com (142.250.217.36) port 443 (#0)
* ALPN, offering h2
* ALPN, offering http/1.1
* error setting certificate verify locations:
*   CAfile: /etc/ssl/certs/ca-certificates.crt
*   CApath: /etc/ssl/certs
* SSL certificate problem: unable to get local issuer certificate
* Closing connection 0
curl: (60) SSL certificate problem: unable to get local issuer certificate
```
ğŸ‘‰ è¡¨ç¤ºå®¹å™¨é‡Œæ²¡è£… ca-certificates æˆ–ä¿¡ä»»åº“ä¸å®Œæ•´ï¼Œå¯¼è‡´æ‰¾ä¸åˆ°ç­¾å‘è€…ã€‚
è¿™å°±æ˜¯ä½ ä¹‹å‰å®¹å™¨é‡Œåªæœ‰ 4 å¼ è¯ä¹¦æ—¶çš„å…¸å‹æƒ…å†µã€‚

â¸»

âŒ å¸¸è§å¤±è´¥ 2ï¼šåŸŸåä¸åŒ¹é…ï¼ˆç”¨ IP è®¿é—®ï¼‰
```
$ curl -v https://142.250.217.36 -o /dev/null
*   Trying 142.250.217.36:443...
* Connected to 142.250.217.36 (142.250.217.36) port 443 (#0)
* Server certificate:
*  subject: CN=www.google.com
*  start date: Sep  5 07:00:00 2024 GMT
*  expire date: Nov 28 07:00:00 2024 GMT
*  issuer: C=US; O=Google Trust Services; CN=GTS CA 1C3
*  SSL: no alternative certificate subject name matches target host name '142.250.217.36'
* Closing connection 0
curl: (60) SSL: no alternative certificate subject name matches target host name '142.250.217.36'
```
ğŸ‘‰ è¯ä¹¦åªå¯¹ www.google.com æœ‰æ•ˆï¼Œä¸å¯¹ IP æœ‰æ•ˆã€‚ç”¨ IP å°±ä¼šæŠ¥ no alternative certificate subject name matchesã€‚

â¸»

âŒ å¸¸è§å¤±è´¥ 3ï¼šæœåŠ¡å™¨è¦æ±‚å®¢æˆ·ç«¯è¯ä¹¦ï¼ˆmTLSï¼‰
```
* TLSv1.2 (IN), TLS handshake, Certificate request
* TLSv1.2 (OUT), TLS handshake, Certificate (11):
* SSL certificate problem: self signed certificate in certificate chain
curl: (58) unable to set private key file: client.key type PEM
```
ğŸ‘‰ å¯¹æ–¹åœ¨ TLS æ¡æ‰‹æ—¶è¦æ±‚ å®¢æˆ·ç«¯è¯ä¹¦ï¼Œå¦‚æœä½ æ²¡æä¾› .crt/.key æˆ– .pfxï¼Œä¼šå¤±è´¥ã€‚

â¸»

âŒ å¸¸è§å¤±è´¥ 4ï¼šæ—¶é—´ä¸å¯¹
```
* Server certificate:
*  subject: CN=www.google.com
*  start date: Sep  5 07:00:00 2024 GMT
*  expire date: Nov 28 07:00:00 2024 GMT
*  SSL certificate problem: certificate is not yet valid
```
ğŸ‘‰ è¯´æ˜å®¹å™¨ç³»ç»Ÿæ—¶é—´ä¸å‡†ï¼ˆæ¯”è¯ä¹¦ç”Ÿæ•ˆæ—¶é—´æ—©ï¼‰ï¼Œæ ¡éªŒå¤±è´¥ã€‚è¦åŒæ­¥ NTPã€‚

â¸»

ğŸ”‘ ç»“è®º
	â€¢	çœ‹åˆ° SSL certificate verify ok. â†’ è¯´æ˜å®¹å™¨æ ¹è¯ä¹¦æ­£å¸¸ï¼ŒTLS æ ¡éªŒé€šè¿‡ã€‚
	â€¢	æŠ¥ unable to get local issuer certificate â†’ å®¹å™¨ç¼ºå°‘ ca-certificates åŒ…ã€‚
	â€¢	æŠ¥ no alternative certificate subject name matches â†’ ç”¨äº† IP æˆ–åŸŸåä¸å¯¹ã€‚
	â€¢	æŠ¥ certificate is not yet valid â†’ å®¹å™¨æ—¶é—´é”™è¯¯ã€‚
	â€¢	æŠ¥ certificate required â†’ å¯¹æ–¹è¦æ±‚å®¢æˆ·ç«¯è¯ä¹¦ï¼ˆmTLSï¼‰ã€‚

â¸»
