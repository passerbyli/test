import{r as S,G as k}from"./index-3eR4IEZC.js";import{_ as E,f as A,o as z,c as b,b as B,n as D,e as l,t as g,i as x}from"./index-C6GkaOyR.js";const T={id:"field-graph",class:"w-full h-full relative"},$={class:"text-gray-500"},F={class:"text-gray-500"},N={class:"text-gray-500"},C={__name:"Test4View",setup(M){const t=A({visible:!1,x:0,y:0,field:"",table:"",type:"",comment:"",nodeId:"",anchor:null});let f=null;function v(){f.getEdges().forEach(s=>{const a=s.getModel();f.setItemState(s,"highlight",a.target===t.value.table&&a.targetAnchor===t.value.anchor)})}function y(){f.getEdges().forEach(s=>{const a=s.getModel();f.setItemState(s,"highlight",a.source===t.value.table&&a.sourceAnchor===t.value.anchor)})}function _(){alert(`字段跳转：${t.value.table}.${t.value.field}`)}return z(()=>{const s=[{name:"orders",fields:[{name:"order_id",type:"int",comment:"订单ID"},{name:"customer_id",type:"int",comment:"客户ID"}]},{name:"special_orders",fields:[{name:"oid",type:"int",comment:"订单ID"},{name:"cid",type:"int",comment:"客户ID"}]}],a=[{source:"orders.order_id",target:"special_orders.oid"},{source:"orders.customer_id",target:"special_orders.cid"}],w=s.map(e=>{const n=(e.fields.length+1)*20+10;return{id:e.name,label:e.name,type:"table-node",size:[200,n],fields:e.fields}}),I=a.map(({source:e,target:n})=>{var h,d;const[c,o]=e.split("."),[i,r]=n.split(".");return{source:c,target:i,sourceAnchor:((h=s.find(m=>m.name===c))==null?void 0:h.fields.findIndex(m=>m.name===o))+1,targetAnchor:((d=s.find(m=>m.name===i))==null?void 0:d.fields.findIndex(m=>m.name===r))+1}});S("table-node",{draw(e,n){const{label:c,fields:o}=e,i=200,r=(o.length+1)*20+10,h=n.addShape("rect",{attrs:{x:-200/2,y:-r/2,width:i,height:r,radius:4,stroke:"#5B8FF9",fill:"#fff"},name:"table-box",draggable:!0});return n.addShape("text",{attrs:{text:c,x:0,y:-r/2+20,fontSize:14,fill:"#000",textAlign:"center",textBaseline:"middle"},name:"table-title"}),o.forEach((d,m)=>{const p=-r/2+20*(m+2);n.addShape("text",{attrs:{text:d.name,x:-200/2+20,y:p,fontSize:12,fill:"#333",textAlign:"start",textBaseline:"middle",cursor:"pointer"},name:`field-${d.name}`}),n.addShape("rect",{attrs:{x:-200/2,y:p-10,width:i,height:20,fill:"transparent",cursor:"pointer"},name:`field-bg-${d.name}`})}),h},getAnchorPoints(e){return e.fields.map((c,o)=>[0,(o+2)/(e.fields.length+3)])}},"single-node");const u=new k({container:"field-graph",width:window.innerWidth,height:window.innerHeight,layout:{type:"dagre",rankdir:"LR",nodesep:50,ranksep:100},defaultNode:{type:"table-node"},defaultEdge:{style:{stroke:"#999",endArrow:!0},stateStyles:{highlight:{stroke:"#f00",lineWidth:2}}},modes:{default:["drag-canvas","zoom-canvas","drag-node"]}});u.data({nodes:w,edges:I}),u.render(),f=u,u.on("node:contextmenu",e=>{var h;e.preventDefault();const n=e.item.getModel(),{shape:c}=e;if(!c||!((h=c.cfg.name)!=null&&h.startsWith("field-")))return;const o=c.cfg.name.replace("field-",""),i=n.fields.findIndex(d=>d.name===o);if(console.log("当前 shape 字段名:",o),console.log("模型字段列表:",n.fields.map(d=>d.name)),i===-1||i===void 0){console.warn(`字段未找到: ${o} in ${n.id}`);return}const r=n.fields[i];t.value={visible:!0,x:e.clientX,y:e.clientY,table:n.id,field:r.name,type:r.type,comment:r.comment,anchor:i+1}}),u.on("canvas:click",()=>{t.value.visible=!1,u.getEdges().forEach(e=>u.clearItemStates(e))})}),(s,a)=>(x(),b("div",T,[t.value.visible?(x(),b("div",{key:0,style:D({left:t.value.x+"px",top:t.value.y+"px"}),class:"absolute bg-white border p-2 text-sm rounded shadow z-10"},[l("div",null,[l("strong",null,g(t.value.field),1)]),l("div",$,"所属表："+g(t.value.table),1),l("div",F,"字段类型："+g(t.value.type),1),l("div",N,"说明："+g(t.value.comment),1),l("div",{class:"mt-2 space-y-1"},[l("button",{onClick:v,class:"text-blue-500 hover:underline"},"查看来源字段"),a[0]||(a[0]=l("br",null,null,-1)),l("button",{onClick:y,class:"text-blue-500 hover:underline"},"查看去向字段"),a[1]||(a[1]=l("br",null,null,-1)),l("button",{onClick:_,class:"text-green-600 hover:underline"},"查看字段血缘图")])],4)):B("",!0)]))}},W=E(C,[["__scopeId","data-v-1d0075b2"]]);export{W as default};
